---
import type { TextTag } from "./types";
import type { Polymorphic } from "astro/types";

type Props<T extends TextTag = "p"> = Polymorphic<{ as: T }> & {
	text: string;
	class?: string;
	group?: string;
};

export type AppearingTextProps = Props;
const {
	as: Tag = "p",
	class: className = "prose",
	text: rawText="",
	group,
	...other
} = Astro.props;

const textArr = rawText.split(/(\s)/);
const text = [];
for (const w of textArr) {
	if (/^\s$/.test(w)) text[text.length - 1] += w;
	else text.push(w);
}
---

<!-- TODO: FIX TYPE -->
<Tag class:list={[className]} data-appearing-group={group} {...other as any}>
	{
		text.map((w) => {
			return <span class="appearing-word">{w}</span>;
		})
	}
</Tag>

<style lang="scss" is:global>
	.appearing-word {
		@apply motion-safe:transition-opacity motion-safe:duration-500 motion-safe:will-change-opacity;
	}
	[data-audio-timings].playing {
		:where(&.has-fading-words .appearing-word) {
			opacity: 0;
		}

		&.has-finished-words .appearing-word {
			display: none;
		}

		.appearing-word {
			&.word-hide-before,
			&.word-hide-before ~ .appearing-word {
				opacity: 1;
			}

			&.last-finished-transition ~ .appearing-word {
				display: inline;
			}

			&.word-last-visible ~ .appearing-word {
				opacity: 0;
				& + .appearing-word {
					display: none;
				}
			}
		}
	}
</style>

<script>
	import "./init"
</script>
